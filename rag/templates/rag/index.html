{% extends "rag/base.html" %}

{% block content %}
<div class="query-section">
    <h2>å°ç£å°ˆåˆ©æœå°‹ç³»çµ±</h2>

    <form method="POST" action="{% url 'query_page' %}" class="query-form" id="queryForm">
        {% csrf_token %}
        <div class="form-group">
            <textarea
                name="question"
                id="question"
                rows="4"
                placeholder="ä¾‹å¦‚: è«‹æ‰¾å‡ºèˆ‡äººå·¥æ™ºæ…§ç›¸é—œçš„å°ˆåˆ©"
                required
            >{{ question }}</textarea>
        </div>
        <button type="submit" class="btn-primary" id="submitBtn">æœå°‹å°ˆåˆ©</button>
    </form>

    <!-- Loading å‹•ç•« -->
    <div id="loadingSection" class="loading-section" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">
            <h3>ğŸ” æ­£åœ¨æœå°‹å°ˆåˆ©è³‡æ–™åº«...</h3>
            <p id="loadingMessage">å‘é‡æª¢ç´¢ä¸­</p>
        </div>
    </div>

    {% if answer %}
    <div class="result-section">
        <h3>ğŸ’¡ å›ç­”</h3>
        <div class="answer-box">
            {{ answer|linebreaks }}
        </div>

        {% if sources %}
        <h3>ğŸ“š ç›¸é—œå°ˆåˆ©</h3>
        <div class="sources-list">
            {% for source in sources %}
            <div class="source-item">
                <h4>{{ source.title }}</h4>
                {% if source.patent_number %}
                <p class="source-section">
                    <strong>å°ˆåˆ©è™Ÿ:</strong>
                    <span class="patent-number">{{ source.patent_number }}</span>
                    <a href="https://tiponet.tipo.gov.tw/S092_OUT/out"
                       target="_blank"
                       class="patent-link"
                       title="å‰å¾€ TIPO å°ˆåˆ©å…¬é–‹è³‡è¨ŠæŸ¥è©¢ç³»çµ±æŸ¥è©¢æ­¤å°ˆåˆ©">
                        æŸ¥è©¢å®Œæ•´å°ˆåˆ© ğŸ”—
                    </a>
                </p>
                {% endif %}
                {% if source.applicant %}
                <p class="source-section"><strong>ç”³è«‹äºº:</strong> {{ source.applicant }}</p>
                {% endif %}
                {% if source.ipc_classification %}
                <p class="source-section"><strong>IPCåˆ†é¡:</strong> {{ source.ipc_classification }}</p>
                {% endif %}
                <p class="source-section"><strong>é¡åˆ¥:</strong> {{ source.section }}</p>
                <p class="source-excerpt">{{ source.excerpt }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="response-time">
            â±ï¸ å›æ‡‰æ™‚é–“: {{ response_time_ms }}ms
        </div>
    </div>
    {% endif %}

    {% if error %}
    <div class="error-box">
        âŒ éŒ¯èª¤: {{ error }}
    </div>
    {% endif %}
</div>

<div class="examples-section">
    <h3>ğŸ’¡ ç¯„ä¾‹æœå°‹</h3>
    <div class="examples-grid">
        <button class="example-btn" onclick="fillQuestion('è«‹æ‰¾å‡ºèˆ‡äººå·¥æ™ºæ…§ç›¸é—œçš„å°ˆåˆ©')">
            äººå·¥æ™ºæ…§å°ˆåˆ©
        </button>
        <button class="example-btn" onclick="fillQuestion('è«‹æ‰¾å‡ºèˆ‡åŠå°é«”è£½ç¨‹ç›¸é—œçš„å°ˆåˆ©')">
            åŠå°é«”è£½ç¨‹
        </button>
        <button class="example-btn" onclick="fillQuestion('è«‹æ‰¾å‡ºèˆ‡é›»æ± æŠ€è¡“ç›¸é—œçš„å°ˆåˆ©')">
            é›»æ± æŠ€è¡“
        </button>
        <button class="example-btn" onclick="fillQuestion('è«‹æ‰¾å‡ºèˆ‡5Gé€šè¨Šç›¸é—œçš„å°ˆåˆ©')">
            5Gé€šè¨ŠæŠ€è¡“
        </button>
        <button class="example-btn" onclick="fillQuestion('è«‹æ‰¾å‡ºèˆ‡ç‰©è¯ç¶²ç›¸é—œçš„å°ˆåˆ©')">
            ç‰©è¯ç¶²æ‡‰ç”¨
        </button>
        <button class="example-btn" onclick="fillQuestion('è«‹æ‰¾å‡ºèˆ‡é†«ç™‚å™¨æç›¸é—œçš„å°ˆåˆ©')">
            é†«ç™‚å™¨æ
        </button>
    </div>
</div>

<script>
function fillQuestion(question) {
    document.getElementById('question').value = question;
}

// Loading animation on form submit
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('queryForm');
    const submitBtn = document.getElementById('submitBtn');
    const loadingSection = document.getElementById('loadingSection');
    const loadingMessage = document.getElementById('loadingMessage');

    if (form) {
        form.addEventListener('submit', function(e) {
            // Show loading section
            loadingSection.style.display = 'block';

            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.6';
            submitBtn.style.cursor = 'not-allowed';

            // Scroll to loading section
            loadingSection.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Progressive loading messages
            const messages = [
                'å‘é‡æª¢ç´¢ä¸­...',
                'åˆ†æå°ˆåˆ©æ–‡ä»¶...',
                'ä½¿ç”¨ AI ç”Ÿæˆå›ç­”...',
                'æ•´ç†å°ˆåˆ©è³‡è¨Š...'
            ];

            let msgIndex = 0;
            const msgInterval = setInterval(function() {
                msgIndex = (msgIndex + 1) % messages.length;
                loadingMessage.textContent = messages[msgIndex];
            }, 3000);

            // Store interval ID to clear it if needed
            form.dataset.loadingInterval = msgInterval;
        });
    }
});
</script>
{% endblock %}
